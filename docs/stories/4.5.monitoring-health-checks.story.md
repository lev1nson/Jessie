# Story 4.5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ health checks

## Status
Ready for Development

## Story
**As a** system administrator,
**I want** –≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã,
**so that** —è –º–æ–≥ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ —É—Å—Ç—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.

## Acceptance Criteria
1. Health check endpoints —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –≤—Å–µ—Ö critical services
2. System status dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç real-time —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
3. Automated alerts –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è critical failures
4. Performance metrics —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
5. User-facing status page –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç system availability

## üöÄ **QUICK START**
Before starting, review: **docs/DEVELOPER_QUICK_REFERENCE.md** for essential commands and checklists.

## Tasks / Subtasks

### Task 1: Health Check Endpoints (AC: 1)
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/health` general health check
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/health/database` –¥–ª—è Supabase connectivity
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/health/gmail` –¥–ª—è Gmail API status
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/health/openai` –¥–ª—è OpenAI API status
- [ ] –°–æ–∑–¥–∞—Ç—å `/api/health/cron` –¥–ª—è cron job status

### Task 2: System Status Dashboard (AC: 2)
- [ ] –°–æ–∑–¥–∞—Ç—å admin dashboard `/dashboard/admin/status`
- [ ] Real-time component status indicators
- [ ] Last sync timestamp –∏ success rate
- [ ] Vector database status –∏ count
- [ ] API response time metrics

### Task 3: Automated Alerting (AC: 3)
- [ ] Integrate —Å Vercel monitoring
- [ ] Setup email alerts –¥–ª—è critical failures
- [ ] Configure Slack/Discord webhooks –¥–ª—è instant notifications
- [ ] Create escalation procedures –¥–ª—è persistent issues
- [ ] Test all alert scenarios

### Task 4: Performance Metrics Collection (AC: 4)
- [ ] Email sync performance tracking
- [ ] Vector search response times
- [ ] Chat API performance metrics
- [ ] Database query performance
- [ ] Resource usage monitoring (memory, CPU)

### Task 5: User Status Page (AC: 5)
- [ ] Create public status page `/status`
- [ ] Show system availability percentage
- [ ] Display scheduled maintenance windows
- [ ] Historical uptime data
- [ ] Subscribe to status updates functionality

### Task 6: Advanced Monitoring Features (AC: 1-5)
- [ ] Error rate tracking –∏ anomaly detection
- [ ] User activity analytics
- [ ] Cost monitoring for external APIs
- [ ] Performance trend analysis
- [ ] Automated performance optimization suggestions

## Dev Notes

### Health Check Architecture
```typescript
// /api/health/route.ts - Master health check
export async function GET() {
  const checks = await Promise.allSettled([
    checkDatabase(),
    checkGmailAPI(),
    checkOpenAI(),
    checkLastCronRun(),
    checkVectorSearch()
  ])
  
  const status = checks.every(check => 
    check.status === 'fulfilled' && check.value.healthy
  ) ? 'healthy' : 'unhealthy'
  
  return Response.json({
    status,
    timestamp: new Date().toISOString(),
    checks: checks.map(formatCheck),
    version: process.env.VERCEL_GIT_COMMIT_SHA
  })
}
```

### Component Health Checks

#### Database Health
```typescript
// /api/health/database/route.ts
async function checkDatabase() {
  try {
    const { data, error } = await supabase
      .from('users')
      .select('count')
      .limit(1)
    
    return {
      healthy: !error,
      responseTime: measureResponseTime(),
      details: error ? error.message : 'Connected'
    }
  } catch (error) {
    return { healthy: false, error: error.message }
  }
}
```

#### Gmail API Health  
```typescript
// /api/health/gmail/route.ts
async function checkGmailAPI() {
  try {
    const response = await gmailClient.checkQuota()
    return {
      healthy: true,
      quotaUsage: response.quotaUsage,
      rateLimitRemaining: response.remaining
    }
  } catch (error) {
    return { healthy: false, error: 'Gmail API unreachable' }
  }
}
```

#### Cron Job Health
```typescript
// /api/health/cron/route.ts  
async function checkCronHealth() {
  const lastRun = await getLastCronExecution()
  const timeSinceLastRun = Date.now() - lastRun.timestamp
  const isHealthy = timeSinceLastRun < 4 * 60 * 60 * 1000 // 4 hours
  
  return {
    healthy: isHealthy,
    lastExecution: lastRun.timestamp,
    lastStatus: lastRun.status,
    nextScheduled: calculateNextRun()
  }
}
```

### Admin Dashboard Components

#### Status Overview Component
```typescript
// components/admin/StatusOverview.tsx
function StatusOverview() {
  const { data: health } = useSWR('/api/health', fetcher, {
    refreshInterval: 30000 // 30 seconds
  })
  
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      <StatusCard 
        title="Database" 
        status={health?.database?.healthy} 
        details={health?.database}
      />
      <StatusCard 
        title="Gmail API" 
        status={health?.gmail?.healthy}
        details={health?.gmail}
      />
      <StatusCard 
        title="OpenAI API" 
        status={health?.openai?.healthy}
        details={health?.openai}
      />
      <StatusCard 
        title="Email Sync" 
        status={health?.cron?.healthy}
        details={health?.cron}
      />
    </div>
  )
}
```

#### Performance Metrics Component
```typescript
// components/admin/PerformanceMetrics.tsx
function PerformanceMetrics() {
  return (
    <div className="space-y-6">
      <MetricChart 
        title="Email Sync Performance"
        metric="emails_synced_per_hour"
        timeRange="24h"
      />
      <MetricChart 
        title="Vector Search Response Time"
        metric="vector_search_response_ms"
        timeRange="24h"
      />
      <MetricChart 
        title="Chat API Response Time"
        metric="chat_api_response_ms" 
        timeRange="24h"
      />
    </div>
  )
}
```

### Alerting Configuration

#### Critical Alert Conditions
```typescript
const alertConditions = {
  // Database unavailable
  database_down: {
    condition: 'health.database.healthy === false',
    severity: 'critical',
    notification: ['email', 'slack']
  },
  
  // Email sync failing
  email_sync_failed: {
    condition: 'cron.lastStatus === "failed" && timeSince > 2hours',
    severity: 'high',
    notification: ['email', 'slack']
  },
  
  // High API error rate
  api_error_rate_high: {
    condition: 'errorRate > 10% over 5 minutes',
    severity: 'medium',
    notification: ['slack']
  },
  
  // Vector search slow
  vector_search_slow: {
    condition: 'avgResponseTime > 5000ms over 10 minutes',
    severity: 'medium',  
    notification: ['slack']
  }
}
```

#### Slack Integration
```typescript
// lib/monitoring/slack.ts
async function sendSlackAlert(alert: Alert) {
  const webhook = process.env.SLACK_WEBHOOK_URL
  
  const message = {
    text: `üö® ${alert.severity.toUpperCase()}: ${alert.title}`,
    attachments: [{
      color: alert.severity === 'critical' ? 'danger' : 'warning',
      fields: [
        { title: 'Component', value: alert.component, short: true },
        { title: 'Status', value: alert.status, short: true },
        { title: 'Details', value: alert.details, short: false }
      ],
      footer: 'Jessie Email Assistant',
      ts: Math.floor(Date.now() / 1000)
    }]
  }
  
  await fetch(webhook, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(message)
  })
}
```

### Metrics Collection

#### Custom Metrics API
```typescript
// /api/metrics/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const metric = searchParams.get('metric')
  const timeRange = searchParams.get('range') || '24h'
  
  const metrics = await collectMetrics(metric, timeRange)
  
  return Response.json({
    metric,
    timeRange,
    data: metrics,
    aggregations: {
      avg: calculateAverage(metrics),
      p95: calculatePercentile(metrics, 95),
      min: Math.min(...metrics),
      max: Math.max(...metrics)
    }
  })
}
```

#### Metric Collection Utils
```typescript
// lib/monitoring/metrics.ts
export async function recordMetric(
  name: string, 
  value: number, 
  tags?: Record<string, string>
) {
  // Store –≤ database table: metrics
  await supabase.from('metrics').insert({
    name,
    value,
    tags,
    timestamp: new Date().toISOString()
  })
  
  // Also send to external monitoring –µ—Å–ª–∏ configured
  if (process.env.DATADOG_API_KEY) {
    await sendToDatadog(name, value, tags)
  }
}

// Usage examples:
await recordMetric('email_sync_duration', syncTime, { status: 'success' })
await recordMetric('vector_search_response_time', responseTime)
await recordMetric('chat_api_requests', 1, { user_id: userId })
```

### Public Status Page

#### Status Page Component
```typescript
// app/status/page.tsx
export default function StatusPage() {
  const { data: status } = useSWR('/api/health', fetcher, {
    refreshInterval: 30000
  })
  
  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">Jessie System Status</h1>
      
      <StatusBanner overall={status?.overall} />
      
      <div className="grid gap-6">
        <ServiceStatus 
          name="Email Processing" 
          status={status?.emailSync} 
        />
        <ServiceStatus 
          name="Chat Interface" 
          status={status?.chatAPI} 
        />
        <ServiceStatus 
          name="Search Engine" 
          status={status?.vectorSearch} 
        />
      </div>
      
      <UptimeChart timeRange="30d" />
      <IncidentHistory />
    </div>
  )
}
```

### Testing Strategy
1. **Health Check Tests**: Verify all endpoints return correct status
2. **Alert Tests**: Simulate failures –∏ verify notifications sent
3. **Performance Tests**: Load test metrics collection
4. **Dashboard Tests**: E2E tests –¥–ª—è admin interface
5. **Status Page Tests**: Public page accessibility –∏ accuracy

### Deployment Considerations

#### Environment Variables
```bash
# Monitoring Configuration
SLACK_WEBHOOK_URL=https://hooks.slack.com/...
ADMIN_EMAIL=admin@example.com
DATADOG_API_KEY=optional_external_monitoring

# Alert Thresholds
EMAIL_SYNC_ALERT_THRESHOLD=7200  # 2 hours
API_ERROR_RATE_THRESHOLD=0.1     # 10%
RESPONSE_TIME_THRESHOLD=5000     # 5 seconds
```

#### Database Schema
```sql
-- Metrics storage table
CREATE TABLE metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  value NUMERIC NOT NULL,
  tags JSONB DEFAULT '{}',
  timestamp TIMESTAMPTZ DEFAULT now(),
  INDEX (name, timestamp),
  INDEX (timestamp)
);

-- System status log
CREATE TABLE system_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  component TEXT NOT NULL,
  status TEXT NOT NULL, -- healthy, degraded, down
  details JSONB,
  timestamp TIMESTAMPTZ DEFAULT now()
);
```

### Success Metrics
- [ ] 99.9% uptime detection accuracy
- [ ] <30 second alert response time
- [ ] 100% critical failure notification delivery
- [ ] <5 minute dashboard load time
- [ ] Zero false positive alerts per week

## Dependencies
- **Requires**: All other Epic 4 stories –¥–ª—è meaningful monitoring
- **Requires**: Slack workspace –¥–ª—è notifications
- **Optional**: External monitoring service integration

## Risks
- **MEDIUM**: Too many false alerts may cause alert fatigue
- **LOW**: Dashboard performance issues —Å large metrics datasets
- **LOW**: External monitoring service costs

### ‚úÖ **COMPLETION VERIFICATION**

**Story 4.5 is DONE when:**
```bash
# 1. Health check endpoints working
curl https://your-app.vercel.app/api/health
# Should return: comprehensive system status

curl https://your-app.vercel.app/api/health/database
curl https://your-app.vercel.app/api/health/gmail  
curl https://your-app.vercel.app/api/health/openai
curl https://your-app.vercel.app/api/health/cron
# All should return: component status

# 2. Admin dashboard accessible
# Go to: https://your-app.vercel.app/dashboard/admin/status
# Should show: real-time component status

# 3. Public status page working
# Go to: https://your-app.vercel.app/status
# Should show: system availability and uptime

# 4. Alerts configured (if applicable)
# Test notification delivery to configured channels
```

## Change Log
| Date | Version | Description | Author |
| :---- | :---- | :---- | :---- |
| 27.07.2025 | 1.0 | Story creation –¥–ª—è Epic 4 integration | Sarah (PO) |
| 27.07.2025 | 1.1 | Added completion verification commands | Bob (SM) |