# Story 1.2: Безопасная аутентификация с Google

## Status
Draft

## Story
**As a** пользователь,
**I want** безопасно подключить свой Google-аккаунт,
**so that** "Jessie" получила разрешение на доступ к моим письмам.

## Acceptance Criteria
1. Используется OAuth 2.0.
2. Пользователь перенаправляется на экран согласия Google.
3. Токены доступа безопасно сохраняются.

## Tasks / Subtasks
- [ ] Task 1: Настройка Google OAuth 2.0 (AC: 1)
  - [ ] Создать проект в Google Cloud Console
  - [ ] Настроить OAuth 2.0 credentials
  - [ ] Настроить разрешения для Gmail API
  - [ ] Добавить переменные окружения для Google OAuth
- [ ] Task 2: Интеграция с Supabase Auth (AC: 1, 3)
  - [ ] Настроить Google OAuth provider в Supabase
  - [ ] Создать middleware для проверки аутентификации
  - [ ] Настроить безопасное хранение токенов в Supabase
- [ ] Task 3: Создание API маршрутов для аутентификации (AC: 2)
  - [ ] Создать /api/auth/google/login endpoint
  - [ ] Создать /api/auth/google/callback endpoint
  - [ ] Создать /api/auth/logout endpoint
  - [ ] Настроить обработку ошибок аутентификации
- [ ] Task 4: Создание компонентов UI для аутентификации (AC: 2)
  - [ ] Создать компонент GoogleLoginButton
  - [ ] Создать страницу входа /auth/login
  - [ ] Создать компонент для отображения статуса аутентификации
  - [ ] Настроить редиректы после успешной аутентификации
- [ ] Task 5: Безопасность и валидация (AC: 3)
  - [ ] Настроить CORS для доменов Google
  - [ ] Добавить валидацию токенов с помощью Zod
  - [ ] Настроить refresh token логику
  - [ ] Добавить логирование событий аутентификации
- [ ] Task 6: Тестирование аутентификации (AC: 1, 2, 3)
  - [ ] Создать unit тесты для API маршрутов
  - [ ] Создать integration тесты для OAuth flow
  - [ ] Создать E2E тесты для полного процесса входа
  - [ ] Тестирование обработки ошибок

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.1.project-setup.story.md]
- Монорепозиторий уже настроен с Next.js 14.2
- Supabase проект инициализирован
- Базовая структура папок создана

### Data Models
[Source: docs/architecture/database-schema.md]
- Использовать таблицу `public.users` для хранения пользователей
- Связь с `auth.users` через Supabase Auth
- Поля: id (UUID), email (TEXT), created_at (TIMESTAMPTZ)

### API Specifications
[Source: docs/architecture/api-specification.md]
- Создать новые API маршруты в apps/web/app/api/auth/
- Использовать Next.js API Routes для обработки OAuth
- Валидация с помощью Zod схем

### Component Specifications
[Source: docs/architecture/tech-stack.md]
- Использовать shadcn/ui ~0.8 для UI компонентов
- Tailwind CSS ~3.4 для стилизации
- Zustand ~4.5 для управления состоянием аутентификации

### File Locations
[Source: docs/architecture/project-structure.md]
```
apps/web/
├── app/
│   ├── api/
│   │   └── auth/
│   │       ├── google/
│   │       │   ├── login/
│   │       │   │   └── route.ts
│   │       │   └── callback/
│   │       │       └── route.ts
│   │       └── logout/
│   │           └── route.ts
│   └── auth/
│       └── login/
│           └── page.tsx
├── components/
│   ├── features/
│   │   └── auth/
│   │       ├── GoogleLoginButton.tsx
│   │       └── AuthStatus.tsx
│   └── ui/
└── lib/
    └── auth.ts
packages/lib/
├── supabaseClient.ts
└── types.ts
```

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]
- **Unit тесты**: Vitest для API маршрутов и компонентов
- **Integration тесты**: Тестирование OAuth flow с моками
- **E2E тесты**: Playwright для полного процесса входа
- **Тест файлы**: Создать рядом с компонентами и API маршрутами

### Technical Constraints
[Source: docs/architecture/coding-standards.md]
- **Строгая типизация**: Использовать типы из packages/lib/types.ts
- **Валидация данных**: Все API маршруты должны использовать Zod
- **Переменные окружения**: Доступ к Google OAuth секретам через конфигурационный модуль
- **Соглашения именования**: PascalCase для компонентов, camelCase для функций

### Testing
[Source: docs/architecture/testing-strategy.md]
- **API тесты**: Создать __tests__ рядом с API маршрутами
- **Компонент тесты**: Component.test.tsx рядом с компонентами
- **E2E тесты**: В папке e2e для тестирования полного flow
- **Моки**: Использовать моки для Google OAuth в тестах

## Change Log
| Date | Version | Description | Author |
| :---- | :---- | :---- | :---- |
| 24.07.2025 | 1.0 | Создание истории | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*Заполняется разработчиком*

### Debug Log References
*Заполняется разработчиком*

### Completion Notes List
*Заполняется разработчиком*

### File List
*Заполняется разработчиком*

## QA Results
*Заполняется QA агентом* 