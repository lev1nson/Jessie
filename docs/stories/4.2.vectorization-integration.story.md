# Story 4.2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å email pipeline

## Status
Ready for Development

## Story
**As a** system,
**I want** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ –ø–∏—Å—å–º–æ –ø–æ—Å–ª–µ –µ–≥–æ —Å–±–æ—Ä–∞,
**so that** –≤—Å–µ –ø–∏—Å—å–º–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.

## Acceptance Criteria
1. Email sync pipeline –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∏—Å—å–º–∞
2. –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç text –∏–∑ email body –∏ –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
3. Vectors —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ pgvector —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ embedding dimensions
4. Failed vectorization –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç email sync process
5. Vectorization cache –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
6. **NEW**: Duplicate email detection - —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
7. **NEW**: Cost optimization - –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º
8. **NEW**: Skip re-vectorization - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–µ–∫—Ç–æ—Ä—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
9. **DATABASE**: Vector search function schema —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç emails table
10. **DATABASE**: –í—Å–µ database migrations –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üöÄ **QUICK START**
Before starting, review: **docs/DEVELOPER_QUICK_REFERENCE.md** for essential commands and checklists.

## Tasks / Subtasks

### Task 1: Integration Email Sync ‚Üí Vectorization (AC: 1)
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `/api/cron/email-sync/route.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ VectorizationService –ø–æ—Å–ª–µ email save
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å async vectorization —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å sync
- [ ] –î–æ–±–∞–≤–∏—Ç—å error handling –¥–ª—è vectorization failures

### Task 2: Attachment Processing Integration (AC: 2)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ AttachmentProcessor –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É PDF –∏ DOCX parsing
- [ ] –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è unsupported attachment types
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å memory usage –¥–ª—è –±–æ–ª—å—à–∏—Ö files

### Task 3: Vector Storage Optimization (AC: 3)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å pgvector configuration –≤ Supabase
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ HNSW indices —Å–æ–∑–¥–∞–Ω—ã
- [ ] Validate embedding dimensions (1536 for OpenAI)
- [ ] –¢–µ—Å—Ç vector similarity search performance

### Task 4: Error Recovery –∏ Resilience (AC: 4)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è failed vectorization
- [ ] –î–æ–±–∞–≤–∏—Ç—å dead letter queue –¥–ª—è persistent failures
- [ ] Create monitoring –¥–ª—è vectorization success rates
- [ ] Separate vectorization errors –æ—Ç email sync errors

### Task 5: Vectorization Cache Integration (AC: 5)
- [ ] –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å VectorizationCache –∏–∑ Story 1.5
- [ ] Configure cache TTL –∏ eviction policies
- [ ] Add metrics –¥–ª—è cache hit rates
- [ ] Optimize cache key generation –¥–ª—è consistency

### Task 6: Duplicate Detection –¥–ª—è Cost Optimization (AC: 6, 7, 8)
- [ ] Integrate `emailRepository.filterNewEmails()` –ø–µ—Ä–µ–¥ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
- [ ] Check if email already has vector (`vectorized_at` field not null)
- [ ] Skip vectorization –¥–ª—è emails —Å existing vectors
- [ ] Add logging –¥–ª—è skipped vectorization operations
- [ ] Measure cost savings from duplicate prevention

### Task 7: Database Schema Fix (AC: 9, 10)
- [ ] Fix match_emails function –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è emails table schema
- [ ] Update function parameters: sent_at ‚Üí date_sent
- [ ] Remove non-existent fields: metadata, text_chunks
- [ ] Add proper return fields: sender, recipient
- [ ] Test vector search function —Å real data
- [ ] Verify HNSW indexes —Ä–∞–±–æ—Ç–∞—é—Ç correctly

### Task 8: Performance Testing –∏ Optimization (AC: 1-8)
- [ ] Load test vectorization —Å 100+ emails
- [ ] Measure vectorization latency per email
- [ ] Test memory usage –ø–æ–¥ load
- [ ] Optimize batch processing –¥–ª—è multiple emails
- [ ] **NEW**: Test duplicate detection performance —Å large datasets
- [ ] **NEW**: Measure cost reduction from skipping existing vectors

## Dev Notes

### Current Implementation Status
- ‚úÖ VectorizationService –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω (Story 1.5)
- ‚úÖ AttachmentProcessor supports PDF/DOCX
- ‚úÖ VectorRepository —Å pgvector integration –≥–æ—Ç–æ–≤
- ‚úÖ VectorizationCache —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ **NEW**: EmailRepository.filterNewEmails() –¥–ª—è duplicate detection
- ‚úÖ **NEW**: Cost optimization –ª–æ–≥–∏–∫–∞ –≤ cron job (processUserEmails)
- ‚úÖ **DATABASE**: Vector search function schema fixed
- ‚úÖ **DATABASE**: All database fields properly aligned
- ‚ùå Email sync –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å vectorization
- ‚ùå Error handling –º–µ–∂–¥—É services –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### Integration Architecture
```typescript
// Modified email-sync/route.ts
async function syncEmails() {
  const emails = await gmailService.fetchNewEmails()
  
  // NEW: Filter out duplicates before processing
  const newEmails = await emailRepository.filterNewEmails(emails)
  
  for (const email of newEmails) {
    // 1. Save email first
    const savedEmail = await emailRepository.save(email)
    
    // 2. NEW: Check if already vectorized
    if (savedEmail.vectorized_at) {
      console.log('Skipping vectorization - already processed:', savedEmail.id)
      continue
    }
    
    // 3. Trigger async vectorization only for new emails
    try {
      await vectorizationService.processEmail(savedEmail)
    } catch (error) {
      // Log but don't fail email sync
      console.error('Vectorization failed for email:', savedEmail.id, error)
    }
  }
}
```

### File Locations
```
apps/web/app/api/cron/email-sync/route.ts           # Main integration point
apps/web/lib/services/vectorizationService.ts       # Existing service
apps/web/lib/services/asyncAttachmentProcessor.ts   # Existing processor
apps/web/lib/repositories/vectorRepository.ts       # Existing repository
apps/web/lib/utils/vectorizationCache.ts           # Existing cache
```

### Required Modifications

#### 1. Email Sync Integration
```typescript
// In email-sync/route.ts, add:
import { VectorizationService } from '@/lib/services/vectorizationService'

const vectorizationService = new VectorizationService()

// After email save:
await vectorizationService.processEmailAsync(email)
```

#### 2. Async Processing Pattern
```typescript
async processEmailAsync(email: Email): Promise<void> {
  // Non-blocking async processing
  setImmediate(async () => {
    try {
      await this.processEmail(email)
    } catch (error) {
      await this.handleVectorizationError(email, error)
    }
  })
}
```

### Success Metrics
- [ ] 100% emails get vectorization attempt
- [ ] >95% vectorization success rate
- [ ] <30 seconds average vectorization time per email
- [ ] Cache hit rate >50% for duplicate content
- [ ] Email sync not delayed by vectorization
- [ ] **NEW**: 0% duplicate email processing rate
- [ ] **NEW**: >80% cost reduction from skipping existing vectors
- [ ] **NEW**: Duplicate detection adds <1 second to sync time

### FIXED Database Schema (match_emails function)
```sql
-- FIXED: Vector search function —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ field names
CREATE OR REPLACE FUNCTION match_emails(
  query_embedding vector(1536),
  match_threshold float,
  match_count int,
  user_id_filter uuid DEFAULT NULL
)
RETURNS TABLE (
  id uuid,
  subject text,
  body_text text,
  date_sent timestamptz,  -- FIXED: was sent_at
  sender text,             -- ADDED: missing field
  recipient text,          -- ADDED: missing field
  similarity float
)
-- REMOVED: metadata, text_chunks (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ emails table)

-- Ensure HNSW index exists:
CREATE INDEX IF NOT EXISTS emails_embedding_hnsw_idx 
ON emails USING hnsw (embedding vector_cosine_ops);
```

### Performance Targets
- Vectorize 50 emails in parallel without memory issues
- Vector search results in <2 seconds
- Attachment processing for 10MB files in <30 seconds
- Cache reduces vectorization time by 50% for duplicates

### Error Handling Strategy
1. **Transient Errors**: Retry with exponential backoff
2. **Permanent Errors**: Log and skip, don't block email sync
3. **Rate Limit Errors**: Queue for later processing
4. **Memory Errors**: Process smaller batches

### Testing Approach
1. **Unit Tests**: Mock VectorizationService in email sync tests
2. **Integration Tests**: Full pipeline with real vectorization
3. **Load Tests**: 100+ emails with various attachment types
4. **Error Tests**: Simulate OpenAI API failures and recovery

### Security Considerations
- OpenAI API keys securely stored in environment
- Email content validated before sending to OpenAI
- User data isolation in vector storage
- No sensitive data logged in vectorization errors

### Monitoring Requirements
- Vectorization success/failure rates
- Average processing time per email
- OpenAI API usage and costs
- Memory usage during peak loads
- Cache performance metrics

## Dependencies
- **Requires**: Story 4.1 (Backend activation) completed
- **Requires**: OpenAI API access with sufficient quota
- **Requires**: Supabase pgvector properly configured
- **Blocks**: Story 4.3 (Chat integration) requires vectorized data

## Risks
- **HIGH**: OpenAI API failures could stop all vectorization
- **MEDIUM**: Large attachments may cause memory issues
- **MEDIUM**: Vector storage costs may scale quickly
- **LOW**: Cache invalidation issues could affect performance

### ‚úÖ **COMPLETION VERIFICATION**

**Story 4.2 is DONE when:**
```bash
# 1. Emails automatically vectorized after sync
# In Supabase SQL:
SELECT COUNT(*) FROM emails WHERE embedding IS NOT NULL;
# Should return: number > 0 (matching synced emails)

# 2. Duplicate detection working
# Repeated sync should not re-vectorize existing emails
curl -X GET "https://your-app.vercel.app/api/cron/email-sync" \
  -H "Authorization: Bearer your-cron-secret"
# Logs should show "Skipping vectorization - already processed"

# 3. Vector search function works
# In Supabase SQL:
SELECT * FROM match_emails(
  '[1,2,3...]'::vector(1536), 
  0.7, 
  5, 
  'user-id'::uuid
);
# Should return: search results with similarity scores
```

## Change Log
| Date | Version | Description | Author |
| :---- | :---- | :---- | :---- |
| 27.07.2025 | 1.0 | Story creation for Epic 4 integration | Sarah (PO) |
| 27.07.2025 | 1.1 | Added completion verification commands | Bob (SM) |